"use strict";(self.webpackChunkhydro_dev_github_io=self.webpackChunkhydro_dev_github_io||[]).push([[9236],{7185:(s,n,a)=>{a.r(n),a.d(n,{data:()=>l});const l=JSON.parse('{"key":"v-55131a51","path":"/dev/third-party-auth.html","title":"接入第三方账号系统","lang":"en-US","frontmatter":{"description":"Hydro 支持接入第三方的账号系统，并且有以下内置模块可用： @hydrooj/login-with-github; @hydrooj/login-with-google; 对接其他平台 在阅读本节之前，请确保你已阅读 【插件开发】 章节。 以 Github 登录为例：","head":[["meta",{"property":"og:url","content":"https://hydro.js.org/dev/third-party-auth.html"}],["meta",{"property":"og:site_name","content":"Hydro"}],["meta",{"property":"og:title","content":"接入第三方账号系统"}],["meta",{"property":"og:description","content":"Hydro 支持接入第三方的账号系统，并且有以下内置模块可用： @hydrooj/login-with-github; @hydrooj/login-with-google; 对接其他平台 在阅读本节之前，请确保你已阅读 【插件开发】 章节。 以 Github 登录为例："}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"en-US"}],["meta",{"property":"og:updated_time","content":"2023-12-26T15:12:47.000Z"}],["meta",{"property":"article:modified_time","content":"2023-12-26T15:12:47.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"接入第三方账号系统\\",\\"image\\":[\\"\\"],\\"dateModified\\":\\"2023-12-26T15:12:47.000Z\\",\\"author\\":[]}"]]},"headers":[{"level":2,"title":"对接其他平台","slug":"对接其他平台","link":"#对接其他平台","children":[]}],"git":{"createdTime":1703603464000,"updatedTime":1703603567000,"contributors":[{"name":"undefined","email":"i@undefined.moe","commits":2}]},"readingTime":{"minutes":1.76,"words":528},"filePathRelative":"dev/third-party-auth.md","localizedDate":"December 26, 2023","autoDesc":true,"excerpt":""}')},4945:(s,n,a)=>{a.r(n),a.d(n,{default:()=>e});var l=a(6252);const p=[(0,l.uE)('<h1 id="接入第三方账号系统" tabindex="-1"><a class="header-anchor" href="#接入第三方账号系统"><span>接入第三方账号系统</span></a></h1><p>Hydro 支持接入第三方的账号系统，并且有以下内置模块可用：</p><ul><li>@hydrooj/login-with-github</li><li>@hydrooj/login-with-google</li></ul><h2 id="对接其他平台" tabindex="-1"><a class="header-anchor" href="#对接其他平台"><span>对接其他平台</span></a></h2><p>在阅读本节之前，请确保你已阅读 【插件开发】 章节。</p><p>以 Github 登录为例：</p><div class="language-typescript line-numbers-mode" data-ext="ts" data-title="ts"><pre class="shiki nord" style="background-color:#2e3440ff;" tabindex="0"><code><span class="line"><span style="color:#81A1C1;">import</span><span style="color:#D8DEE9FF;"> </span><span style="color:#ECEFF4;">{</span></span>\n<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#D8DEE9;">Context</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">ForbiddenError</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">Handler</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">superagent</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">SystemModel</span><span style="color:#ECEFF4;">,</span></span>\n<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#D8DEE9;">TokenModel</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">UserFacingError</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">ValidationError</span><span style="color:#ECEFF4;">,</span></span>\n<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">from</span><span style="color:#D8DEE9FF;"> </span><span style="color:#ECEFF4;">&#39;</span><span style="color:#A3BE8C;">hydrooj</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#81A1C1;">;</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#81A1C1;">declare</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">module</span><span style="color:#D8DEE9FF;"> </span><span style="color:#ECEFF4;">&#39;</span><span style="color:#A3BE8C;">hydrooj</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#D8DEE9FF;"> </span><span style="color:#ECEFF4;">{</span></span>\n<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#81A1C1;">interface</span><span style="color:#D8DEE9FF;"> </span><span style="color:#8FBCBB;">SystemKeys</span><span style="color:#D8DEE9FF;"> </span><span style="color:#ECEFF4;">{</span></span>\n<span class="line"><span style="color:#D8DEE9FF;">        </span><span style="color:#ECEFF4;">&#39;</span><span style="color:#A3BE8C;">login-with-github.id</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> </span><span style="color:#8FBCBB;">string</span><span style="color:#81A1C1;">;</span></span>\n<span class="line"><span style="color:#D8DEE9FF;">        </span><span style="color:#ECEFF4;">&#39;</span><span style="color:#A3BE8C;">login-with-github.secret</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> </span><span style="color:#8FBCBB;">string</span><span style="color:#81A1C1;">;</span></span>\n<span class="line"><span style="color:#D8DEE9FF;">        </span><span style="color:#ECEFF4;">&#39;</span><span style="color:#A3BE8C;">login-with-github.endpoint</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> </span><span style="color:#8FBCBB;">string</span><span style="color:#81A1C1;">;</span></span>\n<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#ECEFF4;">}</span></span>\n<span class="line"><span style="color:#ECEFF4;">}</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#616E88;">// 当用户点击 【使用 XX 登录】 按钮时，此函数会被执行</span></span>\n<span class="line"><span style="color:#81A1C1;">async</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">function</span><span style="color:#D8DEE9FF;"> </span><span style="color:#88C0D0;">get</span><span style="color:#ECEFF4;">(</span><span style="color:#81A1C1;">this:</span><span style="color:#D8DEE9FF;"> </span><span style="color:#8FBCBB;">Handler</span><span style="color:#ECEFF4;">)</span><span style="color:#D8DEE9FF;"> </span><span style="color:#ECEFF4;">{</span></span>\n<span class="line"><span style="color:#ECEFF4;">    </span><span style="color:#616E88;">// 从系统设置中获取基础设置，并储存状态信息（完成登录逻辑后应该跳转到哪一页）</span></span>\n<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9FF;"> </span><span style="color:#ECEFF4;">[</span><span style="color:#D8DEE9;">appid</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#ECEFF4;">[</span><span style="color:#D8DEE9;">state</span><span style="color:#ECEFF4;">]]</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">await</span><span style="color:#D8DEE9FF;"> </span><span style="color:#8FBCBB;">Promise</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">all</span><span style="color:#D8DEE9FF;">([</span></span>\n<span class="line"><span style="color:#D8DEE9FF;">        </span><span style="color:#D8DEE9;">SystemModel</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">get</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#A3BE8C;">login-with-github.id</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#ECEFF4;">,</span></span>\n<span class="line"><span style="color:#D8DEE9FF;">        </span><span style="color:#D8DEE9;">TokenModel</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">add</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">TokenModel</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">TYPE_OAUTH</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#B48EAD;">600</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#ECEFF4;">{</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">redirect</span><span style="color:#ECEFF4;">:</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">this</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">request</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">referer</span><span style="color:#D8DEE9FF;"> </span><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;">)</span><span style="color:#ECEFF4;">,</span></span>\n<span class="line"><span style="color:#D8DEE9FF;">    ])</span><span style="color:#81A1C1;">;</span></span>\n<span class="line"><span style="color:#ECEFF4;">    </span><span style="color:#616E88;">// 将用户重定向至第三方平台请求授权。</span></span>\n<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#81A1C1;">this</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">response</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">redirect</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> </span><span style="color:#ECEFF4;">`</span><span style="color:#A3BE8C;">https://github.com/login/oauth/authorize?client_id=</span><span style="color:#ECEFF4;">${</span><span style="color:#D8DEE9;">appid</span><span style="color:#ECEFF4;">}</span><span style="color:#A3BE8C;">&amp;state=</span><span style="color:#ECEFF4;">${</span><span style="color:#D8DEE9;">state</span><span style="color:#ECEFF4;">}</span><span style="color:#A3BE8C;">&amp;scope=read:user,user:email</span><span style="color:#ECEFF4;">`</span><span style="color:#81A1C1;">;</span></span>\n<span class="line"><span style="color:#ECEFF4;">}</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#616E88;">// 当用户在三方系统中完成授权，需要重定向到 /oauth/xxx/callback，这时所有返回的参数作为 callback 的一参数传入。</span></span>\n<span class="line"><span style="color:#81A1C1;">async</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">function</span><span style="color:#D8DEE9FF;"> </span><span style="color:#88C0D0;">callback</span><span style="color:#ECEFF4;">({</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">state</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">code</span><span style="color:#D8DEE9FF;"> </span><span style="color:#ECEFF4;">})</span><span style="color:#D8DEE9FF;"> </span><span style="color:#ECEFF4;">{</span></span>\n<span class="line"><span style="color:#ECEFF4;">    </span><span style="color:#616E88;">// 获取系统设置和之前的状态。</span></span>\n<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9FF;"> </span><span style="color:#ECEFF4;">[[</span><span style="color:#D8DEE9;">appid</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">secret</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">endpoint</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">url</span><span style="color:#ECEFF4;">],</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">s</span><span style="color:#ECEFF4;">]</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">await</span><span style="color:#D8DEE9FF;"> </span><span style="color:#8FBCBB;">Promise</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">all</span><span style="color:#D8DEE9FF;">([</span></span>\n<span class="line"><span style="color:#D8DEE9FF;">        </span><span style="color:#D8DEE9;">SystemModel</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getMany</span><span style="color:#D8DEE9FF;">([</span></span>\n<span class="line"><span style="color:#D8DEE9FF;">            </span><span style="color:#ECEFF4;">&#39;</span><span style="color:#A3BE8C;">login-with-github.id</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#ECEFF4;">,</span></span>\n<span class="line"><span style="color:#D8DEE9FF;">            </span><span style="color:#ECEFF4;">&#39;</span><span style="color:#A3BE8C;">login-with-github.secret</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#ECEFF4;">,</span></span>\n<span class="line"><span style="color:#D8DEE9FF;">            </span><span style="color:#ECEFF4;">&#39;</span><span style="color:#A3BE8C;">login-with-github.endpoint</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#ECEFF4;">,</span></span>\n<span class="line"><span style="color:#D8DEE9FF;">            </span><span style="color:#ECEFF4;">&#39;</span><span style="color:#A3BE8C;">server.url</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#ECEFF4;">,</span></span>\n<span class="line"><span style="color:#D8DEE9FF;">        ])</span><span style="color:#ECEFF4;">,</span></span>\n<span class="line"><span style="color:#D8DEE9FF;">        </span><span style="color:#D8DEE9;">TokenModel</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">get</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">state</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">TokenModel</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">TYPE_OAUTH</span><span style="color:#D8DEE9FF;">)</span><span style="color:#ECEFF4;">,</span></span>\n<span class="line"><span style="color:#D8DEE9FF;">    ])</span><span style="color:#81A1C1;">;</span></span>\n<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#81A1C1;">if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#81A1C1;">!</span><span style="color:#D8DEE9;">s</span><span style="color:#D8DEE9FF;">) </span><span style="color:#81A1C1;">throw</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">new</span><span style="color:#D8DEE9FF;"> </span><span style="color:#88C0D0;">ValidationError</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#A3BE8C;">token</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>\n<span class="line"><span style="color:#ECEFF4;">    </span><span style="color:#616E88;">// 使用从 url 中返回的 token 请求第三方的 API，获取用户信息，作为函数返回。</span></span>\n<span class="line"><span style="color:#ECEFF4;">    </span><span style="color:#616E88;">// 在 OAuth 协议中，需要使用 state 和 code 换取 access_token 再调用 API，这在不同系统中可能设计不同。</span></span>\n<span class="line"><span style="color:#ECEFF4;">    </span><span style="color:#616E88;">// 系统会根据返回的用户信息自动查找已有用户或是创建新用户。</span></span>\n<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">res</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">await</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">superagent</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">post</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">`${</span><span style="color:#D8DEE9;">endpoint</span><span style="color:#A3BE8C;"> </span><span style="color:#81A1C1;">||</span><span style="color:#A3BE8C;"> </span><span style="color:#ECEFF4;">&#39;</span><span style="color:#A3BE8C;">https://github.com</span><span style="color:#ECEFF4;">&#39;}</span><span style="color:#A3BE8C;">/login/oauth/access_token</span><span style="color:#ECEFF4;">`</span><span style="color:#D8DEE9FF;">)</span></span>\n<span class="line"><span style="color:#D8DEE9FF;">        </span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">send</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">{</span></span>\n<span class="line"><span style="color:#D8DEE9FF;">            </span><span style="color:#D8DEE9;">client_id</span><span style="color:#ECEFF4;">:</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">appid</span><span style="color:#ECEFF4;">,</span></span>\n<span class="line"><span style="color:#D8DEE9FF;">            </span><span style="color:#D8DEE9;">client_secret</span><span style="color:#ECEFF4;">:</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">secret</span><span style="color:#ECEFF4;">,</span></span>\n<span class="line"><span style="color:#D8DEE9FF;">            </span><span style="color:#D8DEE9;">code</span><span style="color:#ECEFF4;">,</span></span>\n<span class="line"><span style="color:#D8DEE9FF;">            </span><span style="color:#D8DEE9;">redirect_uri</span><span style="color:#ECEFF4;">:</span><span style="color:#D8DEE9FF;"> </span><span style="color:#ECEFF4;">`${</span><span style="color:#D8DEE9;">url</span><span style="color:#ECEFF4;">}</span><span style="color:#A3BE8C;">oauth/github/callback</span><span style="color:#ECEFF4;">`</span><span style="color:#ECEFF4;">,</span></span>\n<span class="line"><span style="color:#D8DEE9FF;">            </span><span style="color:#D8DEE9;">state</span><span style="color:#ECEFF4;">,</span></span>\n<span class="line"><span style="color:#D8DEE9FF;">        </span><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;">)</span></span>\n<span class="line"><span style="color:#D8DEE9FF;">        </span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">set</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#A3BE8C;">accept</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#ECEFF4;">&#39;</span><span style="color:#A3BE8C;">application/json</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>\n<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#81A1C1;">if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#D8DEE9;">res</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">body</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">error</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">{</span></span>\n<span class="line"><span style="color:#D8DEE9FF;">        </span><span style="color:#81A1C1;">throw</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">new</span><span style="color:#D8DEE9FF;"> </span><span style="color:#88C0D0;">UserFacingError</span><span style="color:#D8DEE9FF;">(</span></span>\n<span class="line"><span style="color:#D8DEE9FF;">            </span><span style="color:#D8DEE9;">res</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">body</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">error</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">res</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">body</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">error_description</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">res</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">body</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">error_uri</span><span style="color:#ECEFF4;">,</span></span>\n<span class="line"><span style="color:#D8DEE9FF;">        )</span><span style="color:#81A1C1;">;</span></span>\n<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#ECEFF4;">}</span></span>\n<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">t</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">res</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">body</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">access_token</span><span style="color:#81A1C1;">;</span></span>\n<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">userInfo</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">await</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">superagent</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">get</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">`${</span><span style="color:#D8DEE9;">endpoint</span><span style="color:#A3BE8C;"> </span><span style="color:#81A1C1;">?</span><span style="color:#A3BE8C;"> </span><span style="color:#ECEFF4;">`${</span><span style="color:#D8DEE9;">endpoint</span><span style="color:#ECEFF4;">}</span><span style="color:#A3BE8C;">/api</span><span style="color:#ECEFF4;">`</span><span style="color:#A3BE8C;"> </span><span style="color:#81A1C1;">:</span><span style="color:#A3BE8C;"> </span><span style="color:#ECEFF4;">&#39;</span><span style="color:#A3BE8C;">https://api.github.com</span><span style="color:#ECEFF4;">&#39;}</span><span style="color:#A3BE8C;">/user</span><span style="color:#ECEFF4;">`</span><span style="color:#D8DEE9FF;">)</span></span>\n<span class="line"><span style="color:#D8DEE9FF;">        </span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">set</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#A3BE8C;">User-Agent</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#ECEFF4;">&#39;</span><span style="color:#A3BE8C;">Hydro-OAuth</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#D8DEE9FF;">)</span></span>\n<span class="line"><span style="color:#D8DEE9FF;">        </span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">set</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#A3BE8C;">Accept</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#ECEFF4;">&#39;</span><span style="color:#A3BE8C;">application/vnd.github.v3+json</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#D8DEE9FF;">)</span></span>\n<span class="line"><span style="color:#D8DEE9FF;">        </span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">set</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#A3BE8C;">Authorization</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#ECEFF4;">`</span><span style="color:#A3BE8C;">token </span><span style="color:#ECEFF4;">${</span><span style="color:#D8DEE9;">t</span><span style="color:#ECEFF4;">}`</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>\n<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#81A1C1;">const</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">ret</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> </span><span style="color:#ECEFF4;">{</span></span>\n<span class="line"><span style="color:#D8DEE9FF;">        </span><span style="color:#D8DEE9;">_id</span><span style="color:#ECEFF4;">:</span><span style="color:#D8DEE9FF;"> </span><span style="color:#ECEFF4;">`${</span><span style="color:#D8DEE9;">userInfo</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">body</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">id</span><span style="color:#ECEFF4;">}</span><span style="color:#A3BE8C;">@github.local</span><span style="color:#ECEFF4;">`</span><span style="color:#ECEFF4;">,</span></span>\n<span class="line"><span style="color:#D8DEE9FF;">        </span><span style="color:#D8DEE9;">email</span><span style="color:#ECEFF4;">:</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">userInfo</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">body</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">email</span><span style="color:#ECEFF4;">,</span></span>\n<span class="line"><span style="color:#D8DEE9FF;">        </span><span style="color:#D8DEE9;">bio</span><span style="color:#ECEFF4;">:</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">userInfo</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">body</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">bio</span><span style="color:#ECEFF4;">,</span></span>\n<span class="line"><span style="color:#ECEFF4;">        </span><span style="color:#616E88;">// 提供多个用户名，若需创建用户则从前往后尝试，直到用户名可用</span></span>\n<span class="line"><span style="color:#D8DEE9FF;">        </span><span style="color:#D8DEE9;">uname</span><span style="color:#ECEFF4;">:</span><span style="color:#D8DEE9FF;"> [</span><span style="color:#D8DEE9;">userInfo</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">body</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">name</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">userInfo</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">body</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">login</span><span style="color:#D8DEE9FF;">]</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">filter</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">i</span><span style="color:#ECEFF4;">)</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">=&gt;</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">i</span><span style="color:#D8DEE9FF;">)</span><span style="color:#ECEFF4;">,</span></span>\n<span class="line"><span style="color:#D8DEE9FF;">        </span><span style="color:#D8DEE9;">avatar</span><span style="color:#ECEFF4;">:</span><span style="color:#D8DEE9FF;"> </span><span style="color:#ECEFF4;">`</span><span style="color:#A3BE8C;">github:</span><span style="color:#ECEFF4;">${</span><span style="color:#D8DEE9;">userInfo</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">body</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">login</span><span style="color:#ECEFF4;">}`</span><span style="color:#ECEFF4;">,</span></span>\n<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#ECEFF4;">}</span><span style="color:#81A1C1;">;</span></span>\n<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#81A1C1;">await</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">TokenModel</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">del</span><span style="color:#D8DEE9FF;">(</span><span style="color:#D8DEE9;">s</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">_id</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">TokenModel</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">TYPE_OAUTH</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>\n<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#81A1C1;">if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#81A1C1;">!</span><span style="color:#D8DEE9;">ret</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">email</span><span style="color:#D8DEE9FF;">) </span><span style="color:#81A1C1;">throw</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">new</span><span style="color:#D8DEE9FF;"> </span><span style="color:#88C0D0;">ForbiddenError</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">You don&#39;t have a verified email.</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>\n<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#81A1C1;">return</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">ret</span><span style="color:#81A1C1;">;</span></span>\n<span class="line"><span style="color:#ECEFF4;">}</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#616E88;">// 注册此模块。</span></span>\n<span class="line"><span style="color:#81A1C1;">export</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">function</span><span style="color:#D8DEE9FF;"> </span><span style="color:#88C0D0;">apply</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">ctx</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> </span><span style="color:#8FBCBB;">Context</span><span style="color:#ECEFF4;">)</span><span style="color:#D8DEE9FF;"> </span><span style="color:#ECEFF4;">{</span></span>\n<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#D8DEE9;">ctx</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">provideModule</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#A3BE8C;">oauth</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#ECEFF4;">&#39;</span><span style="color:#A3BE8C;">github</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#ECEFF4;">{</span></span>\n<span class="line"><span style="color:#D8DEE9FF;">        </span><span style="color:#D8DEE9;">text</span><span style="color:#ECEFF4;">:</span><span style="color:#D8DEE9FF;"> </span><span style="color:#ECEFF4;">&#39;</span><span style="color:#A3BE8C;">Login with Github</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#ECEFF4;">,</span></span>\n<span class="line"><span style="color:#D8DEE9FF;">        </span><span style="color:#D8DEE9;">callback</span><span style="color:#ECEFF4;">,</span></span>\n<span class="line"><span style="color:#D8DEE9FF;">        </span><span style="color:#D8DEE9;">get</span><span style="color:#ECEFF4;">,</span></span>\n<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>\n<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#D8DEE9;">ctx</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">i18n</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">load</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#A3BE8C;">zh</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#ECEFF4;">{</span></span>\n<span class="line"><span style="color:#D8DEE9FF;">        </span><span style="color:#ECEFF4;">&#39;</span><span style="color:#A3BE8C;">Login With Github</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#ECEFF4;">:</span><span style="color:#D8DEE9FF;"> </span><span style="color:#ECEFF4;">&#39;</span><span style="color:#A3BE8C;">使用 Github 登录</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#ECEFF4;">,</span></span>\n<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;">)</span><span style="color:#81A1C1;">;</span></span>\n<span class="line"><span style="color:#ECEFF4;">}</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>',7)],o={},e=(0,a(3744).Z)(o,[["render",function(s,n){return(0,l.wg)(),(0,l.iD)("div",null,p)}]])},3744:(s,n)=>{n.Z=(s,n)=>{const a=s.__vccOpts||s;for(const[s,l]of n)a[s]=l;return a}}}]);